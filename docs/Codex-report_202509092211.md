# Codex Report — 2025-09-09 22:11 JST

対象: Itabashi Minutes / DB・検索の安定化（CJK + LIKEフォールバック）

## 概要
- 症状: 日本語の部分語（例: 「交際費」「行政視察」）が `/search` でヒットしない。
- 原因: FTS5(unicode61)のみだとCJKの部分一致が落ちる。また、ローカルで複数クローンがあり、古いAPIコードが起動されていた。
- 対応: CJK検出→語尾`*`付与でFTSに投げつつ、LIKE(`%q%`)フォールバックを併用し、UNION→DISTINCTで去重。スニペットはFTSの`snippet()`が無ければ`substr()`フォールバック。README/CODEXにトラブルシュートを追記。

## 実装ポイント
- 追加: `is_cjk_query`, `to_fts_query`
- `/search` CTE構成: `f`(FTS), `l`(LIKE), `u`(UNION ALL), `mset`(DISTINCT) で去重して minutes にJOIN。
- 並び順: `order_by=relevance` 時は `COALESCE(f.hits,0)`→日付降順、他は既存どおり。
- スニペット: `snippet(fts)`→`substr(speech_text,1,120)` の順にフォールバック。
- LIKEパターン: 正規化後ではなく「生の `q`」を使用（Glyphレビュー反映）。

## 検証
固定DB（fixtures同等の最小データ）で確認:
- `議会交際費` → id=12（<em>強調あり / hit_count>=1）
- `交際費` → id=12（LIKEフォールバック / hit_count=0 / 強調なし）
- `行政視察` → id=6（強調あり）
- `議会報告会` → id=3（強調あり）

## トラブルシュート（今回の落とし穴）
- 原因: APIを別ディレクトリのクローンから起動していたため、古いコードを参照。
- 対策: 起動時にソース直読みを強制し、DBも絶対パスで指定。
```bash
PYTHONPATH="$(pwd)" poetry run api-serve \
  --db "$(pwd)/var/minutes.db" --host 127.0.0.1 --port 8010
# 代替
poetry run uvicorn api.main:create_app --factory --host 127.0.0.1 --port 8010
```

## フォローアップ（任意）
- `pyproject.toml` の `[tool.poetry.packages]` に `api` を追加し、import衝突を予防。
- CJK判定の強化（半角カナ `\uff61-\uff9f` 追加）検討。
- デバッグ容易化のため、フォールバック経路使用時に `X-Search-Impl: fts+like` 等のレスポンスヘッダを付与する案。

## 参考コマンド
```bash
# 受入確認
curl --get 'http://127.0.0.1:8010/search' --data-urlencode 'q=議会交際費'
curl --get 'http://127.0.0.1:8010/search' --data-urlencode 'q=交際費'
curl --get 'http://127.0.0.1:8010/search' --data-urlencode 'q=行政視察'
```

以上。

