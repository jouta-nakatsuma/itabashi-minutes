# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/9/2025 0:12:24  
**Exported:** 9/9/2025 0:13:14  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 31s

夜間ジョブに関する指示を構成する必要があるようです。GitHub Actionsでスケジュールし、成果物は `catalog.duckdb`, `index.json`, `documents.ndjson`。失敗の場合、Issueを作成し、ログを表示。ジョブはcrawl/build/releaseに分かれ、キャッシュやリトライも考慮。`poetry run`コマンドで処理する指示を `.github/workflows/nightly.yml` に追加します。

`poetry install --only main --with app`は不要かもしれません。安定させるため、並列実行を避けるためにグループ定義が必要です。アーティファクトの保持日数やアップロードを指示。失敗時にIssue作成も組み込み。週次リリースは同じワークフローで月曜日にトリガーまたは別ワークフローにするかも。

16:00 UTC で01:00 JSTに設定するのが正確かな。スケジュールは `0 15 * * *` として、クロールの実行、リトライ／バックオフを追加。環境変数でレート制限や最大ページ数の設定、コマンドをシンプルに保つように。`poetry run` を使ってクロールとデータ構築を実行。

`nightly.py` スクリプトを作成してクロールとビルドを管理し、idempotentに保ち、成果物を計算して `CHANGELOG` として出力。GitHub Actionsでは `$GITHUB_OUTPUT` を使用し、ログやアーティファクトをアップロードします。また、週次リリースに `catalog-YYYYMMDD` タグを付与し、失敗時にIssueを作成します。

完了

了解。#32「Nightly ジョブ（定期クロール＆成果物公開）」の **Codex向け実装指示プロンプト** を用意しました。#29/#30/#31 の成果を前提に、毎晩のクロール→カタログ構築→成果物公開→（週1）Release→失敗時Issue化、までを一気に整えます。

* * *

Codex 実装指示プロンプト（#32 Nightly ジョブ）
--------------------------------

````markdown
# タスク: Nightly ジョブ（定期クロール＆成果物公開）

## 目的
- 毎晩の自動クロールとカタログ生成をGitHub Actionsに載せ、成果物をArtifactsへ保存。
- 週1回はRelease（`catalog-YYYYMMDD`）として固定スナップショットを公開。
- 失敗時は自動でIssueを起票し、ログを添付。

## 成果物/出力
- `dist/catalog.duckdb`
- `dist/index.json`
- `dist/documents.ndjson`（必要に応じて）
- Nightly Artifacts（保持14日）
- 週1 Release：タグ `catalog-YYYYMMDD`、Release名 `Catalog YYYY-MM-DD`
- 失敗時 Issue（タイトル：`Nightly failed YYYY-MM-DD`、本文に失敗ジョブ/ログ要約）

## 実装要件
1) **Workflow: `.github/workflows/nightly.yml` 新規**
   - トリガー:
     - `schedule`: 毎日 JST 深夜帯実行（例：JST 01:00）→ UTC基準で `0 16 * * *`
     - `workflow_dispatch`: 手動実行
   - `permissions`: `contents: write`, `issues: write`, `actions: read`
   - `concurrency`: `group: nightly`, `cancel-in-progress: false`
   - `env`: `TZ: Asia/Tokyo`
   - ジョブ構成（3段）：
     - **crawl_build**: クロール→カタログ構築→成果物保存→件数サマリ出力
     - **artifact_publish**: 成果物をArtifactsへアップロード（retention 14）
     - **weekly_release**: 週1(金)のみ Release を作成（条件分岐）
   - 失敗ハンドリング:
     - `if: failure()` のステップでログを添付して Issue 起票（`actions/github-script`）

2) **オーケストレーションスクリプト**
   - `scripts/nightly.sh`（新規・シェル）または `scripts/nightly.py`（任意・Python）
   - 役割:
     - `dist/` を作り直し
     - クロール実行（既存CLIを使用：`poetry run itabashi-crawler`）
     - 正規化/インデックス化（`poetry run catalog-load` など既存スクリプトで）
     - 主要件数を `stdout` に出力（minutes件数・speeches件数・生成ファイルサイズ）
     - ログを `logs/nightly.log` に残す
   - 例（bash簡易版でOK）：
     ```bash
     #!/usr/bin/env bash
     set -euo pipefail
     mkdir -p dist logs
     : > logs/nightly.log

     echo "[nightly] crawl start $(date -Iseconds)" | tee -a logs/nightly.log
     poetry run itabashi-crawler --out dist/documents.ndjson 2>&1 | tee -a logs/nightly.log

     echo "[nightly] catalog build" | tee -a logs/nightly.log
     poetry run catalog-load --in dist/documents.ndjson --duck dist/catalog.duckdb --index dist/index.json 2>&1 | tee -a logs/nightly.log

     echo "[nightly] summary" | tee -a logs/nightly.log
     python - <<'PY' | tee -a logs/nightly.log
     import json, os
     p = "dist/index.json"
     size = os.path.getsize(p) if os.path.exists(p) else 0
     print(json.dumps({"index_size": size}, ensure_ascii=False))
     PY
     ```

3) **README 追記**
   - Nightlyの概要、Artifacts保存先、手動実行の手順（`workflow_dispatch`）

4) **Makefile（任意）**
   - `make nightly` で `scripts/nightly.sh` を呼ぶファサードを追加

## 変更対象
- 新規: `.github/workflows/nightly.yml`
- 新規: `scripts/nightly.sh`（実行bit付与）
- 更新: `README.md`（Nightlyの項追記）
- （任意）`Makefile`

## 具体仕様（Workflow雛形）
- 次のYAMLをベースに作成（必要に応じて微調整）：

```yaml
name: Nightly

on:
  schedule:
    - cron: '0 16 * * *'   # 01:00 JST (UTC+9)
  workflow_dispatch:

permissions:
  contents: write
  issues: write
  actions: read

concurrency:
  group: nightly
  cancel-in-progress: false

env:
  TZ: Asia/Tokyo
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  crawl_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: '3.10' }
      - name: Install Poetry
        run: pipx install poetry==1.8.3
      - name: Cache Poetry
        uses: actions/cache@v4
        with:
          path: ~/.cache/pypoetry
          key: nightly-poetry-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
          restore-keys: nightly-poetry-${{ runner.os }}-
      - name: Install deps (main only)
        run: poetry install --no-interaction --only main
      - name: Nightly pipeline
        run: |
          chmod +x scripts/nightly.sh
          ./scripts/nightly.sh | tee nightly.out
      - name: Save run summary
        id: sum
        run: |
          echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          COUNT=$(grep -Eo '"index_size": *[0-9]+' nightly.out | awk '{print $2}' | tail -n1)
          echo "COUNT=${COUNT:-0}" >> $GITHUB_OUTPUT
      - name: Upload logs (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-logs-${{ steps.sum.outputs.DATE }}
          path: |
            logs/nightly.log
            nightly.out
          retention-days: 14

  artifact_publish:
    needs: crawl_build
    runs-on: ubuntu-latest
    if: ${{ always() && needs.crawl_build.result == 'success' }}
    steps:
      - uses: actions/checkout@v4
      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: catalog-dist-${{ needs.crawl_build.outputs.DATE || '' }}
          path: |
            dist/catalog.duckdb
            dist/index.json
            dist/documents.ndjson
          retention-days: 14

  weekly_release:
    needs: crawl_build
    runs-on: ubuntu-latest
    if: ${{ always() && needs.crawl_build.result == 'success' && startsWith(github.event.schedule, '0 16') && (fromJSON(format('{0}', toJson(github.event.schedule))) != null) }}
    steps:
      - uses: actions/checkout@v4
      - name: Set date
        id: d
        run: echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: catalog-${{ steps.d.outputs.DATE }}
          name: Catalog ${{ steps.d.outputs.DATE }}
          generate_release_notes: true
          files: |
            dist/catalog.duckdb
            dist/index.json
            dist/documents.ndjson

  on_failure_issue:
    needs: [crawl_build]
    if: ${{ failure() }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/github-script@v7
        with:
          script: |
            const date = new Date().toISOString().slice(0,10);
            const body = `Nightly failed on ${date}

            See uploaded artifact 'nightly-logs-${date}' for logs.`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Nightly failed ${date}`,
              labels: ['ci','nightly','bug'],
              body
            });
````

> 注1: `weekly_release` の曜日条件は簡略化しています。必要なら `if:` 内で `date +%u` が `5`（金曜）かをチェックするステップを挟んでブール出力にしてください。  
> 注2: Release用に `softprops/action-gh-release@v2` を使っています。別アクションでも可。  
> 注3: 生成ファイル名やコマンドは既存スクリプトに合わせて微調整してください。

テスト/受け入れ
--------

*   `workflow_dispatch` で手動実行 → `crawl_build` が成功し、`dist/*` がArtifactsに保存される。
*   失敗ケースを擬似的に作る（例：ネットワーク遮断）と、Issueが自動起票される。
*   金曜の実行で Release が作成され、`dist/*` が添付される。

コミット/PR
-------

*   `feat(ci): nightly crawl/build & artifacts`
*   `feat(ci): weekly catalog release`
*   `chore(scripts): nightly pipeline script`
*   `docs(ci): add nightly docs`

以上の要件で差分（unified diff）を提示し、PR化してください。

```

---

必要なら、週1 Release を別Workflowに切り出す（`release-catalog.yml`）版もすぐ用意できます。
```



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)