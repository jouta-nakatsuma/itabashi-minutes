# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 18:37:15  
**Exported:** 9/8/2025 18:37:55  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 21s

問題 #30について、フィードバックを提供し、問題点を明確にする必要があります。APIの想定、ファイル構造、エッジケースを確認し、具体的な提案を行います。特に、`main()`内でSubprocessを使ったStreamlitの実行が推奨されていない点、`st.*`関数を直接呼び出すべきだと思います。

`python -m streamlit run app/streamlit_app.py` を使うシンプルな方法を提案。`streamlit.web.cli:main` で引数を渡すのが難しければ、`subprocess` の方法も従来通り使えるけど、`main()` で `run()` を呼び出す方法が良さそう。環境設定は `.env` ファイルで対処し、`python-dotenv` は既に依存関係に組み込まれているはず。

キャッシュについて、TTL30秒で`st.cache_data`は良い選択。ただし、パラメータを含むキー関数を加えた方が良いか

完了

レビューしました。結論：**この計画で進めてOK**です。UIフロー・状態管理・APIパラメータの扱いは要件を満たしています。  
その上で、\*\*より堅く・運用しやすくするための修正提案（軽微〜中）\*\*を下にまとめます。必要なところだけCodexに追記してください。

承認ポイント（OK）
==========

*   検索→一覧→詳細の最短ループ定義（q/committee/date\_from/date\_to/order\_by/order/limit/offset）
*   `<em>` ハイライトのHTML描画方針（`unsafe_allow_html=True`）
*   ページャがAPIの `page/has_next` に追従
*   `.env` の `IM_API_BASE` でAPI切替、`@st.cache_data(ttl=30)` 採用

修正提案（採用推奨）
==========

1.  Poetryスクリプトの「起動方式」を明確化  
    現在の「`ui-serve = "app.streamlit_app:main"`」だと、**Streamlitはその関数を直接実行しません**（通常は `streamlit run app/streamlit_app.py` が必要）。二択のどちらかに統一を：
    *   **A: ランチャー方式（推奨）**  
    新規 `app/ui_launcher.py` を作り、公式ブートストラップAPIで起動。
    ```python
    # app/ui_launcher.py
    from pathlib import Path
    from streamlit.web.bootstrap import run
    def main():
        target = str(Path(__file__).parent / "streamlit_app.py")
        run(target, "", [], flag_options={})
    ```
    `pyproject.toml`:
    ```toml
    [tool.poetry.scripts]
    ui-serve = "app.ui_launcher:main"
    ```
*   **B: サブプロセス方式**  
    `streamlit` をサブプロセス起動しても可。ただし Ctrl+C の挙動とログ伝播を確認。Aの方が素直です。
    2.  speakerフィルタは**初期リリースではOFF**  
    一覧→詳細の体感速度を優先。提案の通り「チェック時のみページ内で `/document/{id}` を多重呼び出し」はOKですが、初期値OFF・件数≤10のときのみ有効・30秒キャッシュ、の3点を明文化。
3.  `relevance` のガード  
    `q` が空のとき `order_by=relevance` を受け取ったら **UI側で `date desc` にフォールバック**（API側も既にフォールバック済ですが、UI上も表示を合わせると混乱が減ります）。
4.  日付のISO化と未入力ガード  
    `st.date_input` は `datetime.date` を返すので、クエリ化時に `isoformat()` し、`date_from <= date_to` のバリデーションで `st.warning` を表示。
5.  API呼び出しの堅牢化
    *   `requests.get(..., timeout=(3.0, 10.0))` を明示
*   失敗時は `st.error(f"API error {resp.status_code}: {resp.text[:200]}")`
*   `IM_API_BASE` 未設定時は `http://127.0.0.1:8000` 既定＋UIヘッダに表示
    6.  UI細部
    *   ハイライト：`<em>` をCSSで太字＋背景薄色（Streamlitテーマに合わせ控えめ）  
    例：`st.markdown("<style>em{font-weight:600}</style>", unsafe_allow_html=True)`
*   一覧：行クリックで詳細へ飛ばす or 「詳細」ボタンのどちらかに統一
*   ページャ：`Prev` は `offset>0` の時のみ活性、`Next` は `has_next` で制御
*   件数：API `limit` の既定が10なので、UIの既定も10で合わせる
    7.  ドキュメント追記（README）
    *   インストール例：`poetry install --with app`
*   起動：`poetry run ui-serve`
*   `.env` サンプル：
    ```
    IM_API_BASE=http://127.0.0.1:8000
    ```
*   既知の制約：話者フィルタはオプション、q未指定時のrelevanceフォールバック

受入チェック（UI手元確認の観点）
=================

*   「給食」で検索 → `<em>` 強調あり、`has_next` に応じてNext制御
*   並び替え：`date asc/desc`, `committee asc/desc`, `relevance`（qありのみ）
*   詳細ビューに `PDFを開く` ボタンあり、本文表示OK
*   `.env` 未設定でも既定ベースURLで動作
*   Ctrl+C でクリーン終了（A案のランチャーならOK）

* * *

この指摘を踏まえ、**承認（Approve）で進行可**です。  
必要なら、上の変更点（特に 1) ランチャー方式）を反映した**追補プロンプト**をすぐ出します。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)