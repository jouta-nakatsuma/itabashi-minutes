# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 20:40:54  
**Exported:** 9/8/2025 20:41:24  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 1m 19s

The user asked us to review the CI diff proposal and suggest if any changes are needed. It looks good overall. I'd suggest pinning the Poetry version (e.g., 1.8.3) to prevent breaks. Also, for the unit job, it might be better to avoid using `poetry lock`—installing with the lock file would be smoother. If everything looks fine, they can approve.

For the unit job, running `poetry lock` might cause lock changes if `pyproject.toml` changes, but that's fine on PR as long as it's committed. It’s better to avoid regenerating the lock in CI. A solution might be using `poetry install --sync`. I’d suggest keeping `poetry lock` for just the mcp job to avoid inconsistencies.

For now, everything looks mostly fine. I’ll quickly confirm a few things:

*   The file should be `ci.yaml` not `ci.yml`—that’s good to check.
*   `mcp-weekly.yml` file is fine.
*   Poetry version should be pinned to 1.8.3.
*   Environment variable `CRAWLER_MIN_RECORDS` seems new; let's verify consistency.
*   `poetry lock` before installation in `mcp-weekly` is good.

The `mcp-smoke` job might face an import issue with `jsonrpcserver` installed, but it looks fine since the group includes it.  
The `poetry lock` step in `mcp-smoke` may cause changes in the lock file, but it's fine in CI.  
I don't think adding `pip cache` or adjusting worker settings is necessary. Also, adding a `timeout` to the MCP server seems good, but a 5-second sleep might be more reliable.

完了

レビュー完了。結論：\*\*この差分は狙いどおりでOK（承認可）\*\*です。  
二系統CI（`unit` と `mcp-smoke`）、optional group 復帰、週次マトリクス、そして最小のコード整備がそろっています。

そのまま「approve apply」で進めて問題ありません。  
…が、より堅くするための微修正を3つだけ提案します（任意）：

1.  Poetryのバージョンを固定  
    現在 `pipx install poetry` で未固定です。CIの再現性のため固定推奨。

```diff
- run: pipx install poetry
+ run: pipx install poetry==1.8.3
```

2.  `poetry lock` の実行位置  
    `unit` ジョブではロック再生成を避け、**`mcp-smoke`/週次のみ**で実行するとロックドリフトの心配が減ります。

```diff
-      - name: Refresh lock (handle pyproject changes)
-        run: poetry lock
```

（この削除は `.github/workflows/ci.yaml` の `unit` ジョブのみでOK。`mcp-smoke` と `mcp-weekly.yml` の `poetry lock` はそのままで良いです）

3.  `mcp-smoke` 起動の待機を少しだけ増やす  
    2秒待機は環境で稀に取りこぼすので、3〜5秒に。

```diff
-          sleep 2
+          sleep 3
```

補足（そのままでOK）

*   cronはUTC基準なので、`'0 18 * * 5'` はJSTで**土曜03:00**です。意図通りならこのままで大丈夫。
*   `unit` の `poetry install --only main,dev` は現状のテスト範囲にマッチ。UI/MCPは別系統で担保できています。
*   `mcp/server.py` の `default_factory` 化・未使用import整理は反映済み。

このまま適用して進めましょう。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)