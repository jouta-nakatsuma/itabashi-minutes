# スプリント2

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 8/26/2025 19:06:41  
**Updated:** 9/2/2025 13:44:05  
**Exported:** 9/2/2025 13:47:37  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68ad872e-c17c-8323-8da9-03d735ff82cd](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68ad872e-c17c-8323-8da9-03d735ff82cd)  

## Response:
思考時間: 12s

穣太さんは、少し控えめで優雅なトーンを好んでいらっしゃるので、カジュアルすぎず、丁寧な言葉遣いを意識します。

まず、pyprojectの変更は避けるべきことを伝え、`scripts/` 配下に２つのスクリプトと、`tests/` 配下にテストを追加します。

次に`one_shot_apply`の特徴を明記し、最低限のユニファイド差分のパース、パスの安全性、既存の適用チェックなどを含め、ログと終了コードの管理を行います。

テスト部分では、簡単なユニファイド差分を使って、スクリプトをモジュールとして実行します。

完了

了解です。下記を**そのまま Codex CLI に貼って**実装を進めてください（Step 5: スクリプト化）。  
pyproject.toml は**一切変更しない**前提です。新規依存も不要です。

* * *

Codex 指示 — Step 5: スクリプト化（安全な差分適用 & カタログ再構築）
============================================

ゴール
---

*   Unified diff を**安全かつ原子的**に適用できる `one_shot_apply.py` を追加する。
*   SQLiteカタログを**再現性よく**作り直せる `rebuild_catalog.py` を追加する。
*   危険度が高い処理のため、**最小でも自動テスト**を付ける。

追加/変更ファイル
---------

```
scripts/
  one_shot_apply.py       # Unified diff の安全適用ユーティリティ
  rebuild_catalog.py      # schema.sql → DB作成 → ロード → 件数/FTS確認

tests/
  test_one_shot_apply.py  # one_shot_apply の最小ユニットテスト（tmp_path）
  test_scripts_rebuild.py # rebuild_catalog のE2E（tmp DB + fixtures）
```

* * *

1) scripts/one\_shot\_apply.py（要件）
----------------------------------

### CLI仕様

*   入力:
    *   標準入力の Unified diff、または `--diff PATH` でファイル指定（どちらか必須）
*   オプション:
    *   `--dry-run` … 解析・適用シミュレーションのみ（**非破壊**）
    *   `--backup` … 適用前に `<file>.bak` を作成
    *   `--strip N` … `patch -pN` 相当（既定 1）。`a/`/`b/` プレフィックス除去などに対応
    *   `--fuzz N` … hunk コンテキストの緩和許容量（既定 0＝**厳格一致**）
    *   `--verbose` … 詳細ログ（INFO/DEBUG）切替

### 安全性・実装要点

*   **パス安全性**:
    *   `repo_root = Path.cwd().resolve()` とし、各ターゲットの `resolve()` が `repo_root` 配下（`is_relative_to`）であることを検証。
    *   絶対パス、`..` を含むパス、`/dev/` などは**拒否**してスキップ（非0終了に含める）。
*   **バイナリ/巨大ファイルの除外**:
    *   `GIT binary patch` / `Binary files differ` を検出したら**スキップ**（警告ログ、失敗扱いにしない）。
    *   1ファイルサイズ上限（例：20MB）を超える場合はスキップ（警告）。
*   **EOL/エンコーディング**:
    *   読込は `open(path, 'r', encoding='utf-8', newline='')`。
    *   出力は**元のEOLを維持**。UTF-8 BOM があれば**維持**。
*   **適用戦略**:
    *   hunk は **行ベース**で適用。既定は no-fuzz、一致しない場合に限って `--fuzz` を使って前後数行内で一致探索。
    *   1ファイル単位で **テンポラリに書き出し → `rename` で原子的置換**。`--backup` 指定時のみ `.bak` を残す。
*   **冪等性**:
    *   すでに適用済み（コンテキスト一致せず、結果が同一）の場合は、「適用済み」として成功扱い（0終了）。
*   **終了コード**:
    *   全 hunk 適用成功→0。1つでも失敗→非0。
    *   最後に要約（対象ファイル数/適用hunk/既適用/スキップ/失敗）を INFO で表示。

### 公開API（テスト用）

*   `parse_unified_diff(text: str, strip: int) -> list[Patch]`
*   `apply_patch_to_file(path: Path, patch: Patch, *, dry_run: bool, fuzz: int, backup: bool, verbose: bool) -> ApplyResult`
*   `apply_to_repo(diff_text: str, *, dry_run: bool, strip: int, fuzz: int, backup: bool, verbose: bool) -> Summary`

> CLI は上記関数を呼び出す薄いラッパにしてください。

* * *

2) scripts/rebuild\_catalog.py（要件）
----------------------------------

### CLI仕様

*   引数:
    *   `--db`（既定 `var/minutes.db`）
    *   `--src`（既定 `data/normalized/`。**存在しない or 空なら `tests/fixtures/` に自動フォールバック**）
    *   `--fresh`（既存DB削除して完全再作成）
    *   `--analyze` / `--vacuum`
    *   `--verbose`
*   手順:
    1.  `--fresh` なら DB を削除
    2.  `catalog/schema.sql` を `executescript`
    3.  `from catalog.load import load_directory` で `(total, inserted, skipped)` を取得
    4.  件数表示：`minutes / agenda_items / speeches / speeches_fts`
    5.  参考出力：`SELECT COUNT(*) FROM speeches_fts WHERE speeches_fts MATCH '教育長 OR 給食'` のヒット数
    6.  `--analyze` / `--vacuum` の実行可否を明示ログ
*   終了コード:
    *   `--fresh` 指定時：`inserted > 0` なら 0、そうでなければ 1
    *   `--fresh` 無し：`inserted >= 0` でも 0（重複により `skipped` が増えるだけの運用も成功扱い）

> 実際に使用した `src` がどちらか（指定 or フォールバック）を INFO ログに必ず表示してください。

* * *

3) テスト
------

### tests/test\_one\_shot\_apply.py

*   方針: `tmp_path` にテスト用の小ファイルを作り、**最小4ケース**を検証。
*   ケース:
    1.  **追加のみ**:
        *   元ファイル A に対する `+ 行` の diff を適用 → 内容が増えて 0 終了。
    2.  **削除のみ**:
        *   元ファイル B から1行削る diff を適用 → 内容が減って 0 終了。
    3.  **混在（追加＋削除）**:
        *   元ファイル C に対し置換を伴う diff → 0 終了、結果一致。
    4.  **コンテキスト不一致 → 失敗**:
        *   hunk が一致しない diff → **非0** 終了を確認、ファイルは**変更されていない**。
*   追加検証（1件でOK）:
    *   **CRLF** の元ファイルに対しても適用が成功し、**EOLが維持**されること。
    *   **冪等性**: 同じ diff を2度流しても2回目は成功（0）かつ内容不変。

> 実行は関数直呼び（上記公開API）でOK。必要に応じて `subprocess` で CLI も1ケースだけ確認可。

### tests/test\_scripts\_rebuild.py

*   準備: `db_path = tmp_path / "minutes.db"`、`src_dir = Path("tests/fixtures")`
*   実行: `rebuild_catalog` の内部関数（必要なら `run(db_path, src_dir, fresh=True, analyze=False, vacuum=False)` のような関数を切り出す）を直接呼ぶ。
*   検証:
    *   `SELECT COUNT(*) FROM minutes` = 1
    *   `SELECT COUNT(*) FROM agenda_items` ≥ 2
    *   `SELECT COUNT(*) FROM speeches` ≥ 4
    *   `SELECT COUNT(*) FROM speeches_fts WHERE speeches_fts MATCH '教育長 OR 給食'` ≥ 2
*   終了コードルールの確認: `--fresh` 相当で `inserted > 0` → 0、**再実行**でも 0。

* * *

4) ログ/エラー規約
-----------

*   例外発生時はスタックトレース＋**対象DBパス／srcパス／対象ファイルパス**を併記。
*   `--verbose` で DEBUG ログを出す（適用行番号、fuzz一致位置など）。

* * *

5) 受入基準（Definition of Done）
---------------------------

*   `poetry run pytest -q tests/test_one_shot_apply.py` がグリーン
*   `poetry run pytest -q tests/test_scripts_rebuild.py` がグリーン
*   下記の手動確認が成功：
    ```bash
    poetry run python scripts/rebuild_catalog.py --db var/minutes.db --src tests/fixtures --fresh --analyze --vacuum --verbose
    ```
    実行後に
    *   minutes ≥ 1
    *   `speeches_fts` の `'教育長 OR 給食'` ヒット数 ≥ 2  
        がINFOで表示される。

* * *

実装後の確認コマンド（開発者向け）
-----------------

```bash
# one_shot_apply のサンプル（dry-run）
git diff HEAD~1 | poetry run python scripts/one_shot_apply.py --dry-run --strip 1

# 実適用
git diff HEAD~1 | poetry run python scripts/one_shot_apply.py --strip 1 --backup

# カタログ再構築（fixturesから）
poetry run python scripts/rebuild_catalog.py --db var/minutes.db --src tests/fixtures --fresh --analyze --vacuum
```

* * *

以上です。  
この要件を満たす差分（unified diff）が上がったら、私がレビューします。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)