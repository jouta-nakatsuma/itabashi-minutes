# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/9/2025 0:26:15  
**Exported:** 9/9/2025 0:26:45  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 1m 5s

I need to go over the Codex implementation plan for Issue #32, particularly for the Nightly Job. We have to review, suggest changes, and ensure scheduling, artifact sizes, failure handling, caching, permissions, and other crucial details are accounted for. I'll also integrate it with previously created scripts and mention necessary dependencies for grants and crawler functionality.

I'm considering splitting the job into steps or separate jobs to handle requirements more efficiently, and using "fail-fast: false." For the weekly release, we can run it on Fridays (UTC/JST). Once we've finalized the cron schedule, I'll confirm if the date function works correctly to trigger as expected on Friday JST.

I’m thinking through the timing of the weekly release. If the job triggers daily at UTC 16:00 (01:00 JST), the weekly release could be set by checking the day in JST. To ensure it's consistent, I'll use `date +%u` to compare and decide if it should run on Friday (5) or Saturday (6) JST.

I’m thinking about artifact retention for 14 days and how to manage release assets. The release job needs to access the 'dist/\*' files, but they aren't available unless artifacts are passed between jobs with 'upload-artifact' and 'download-artifact'. I'll note that not handling this will cause the release steps to fail.

完了

レビュー完了。結論：**この実装プランで進めてOK**ですが、リリース作成周りと出力受け渡しにいくつか**Blocking**があります。そこだけ直せば堅いです。

✅ 良い点
=====

*   毎晩の crawl→build→Artifacts、金曜(週1)の Release、失敗時 Issue 化まで一通り設計できている
*   Poetry 1.8.3 固定、`TZ: Asia/Tokyo`、`permissions`/`concurrency` 設定も適切
*   オーケストレーターを `scripts/nightly.sh` に切り出す方針は再現性◎

🔴 Blocking（必ず直す）
=================

1.  **weekly\_release ジョブで `dist/*` が存在しない**  
    別ジョブなので、リリース作成前に **Artifact を download** してください。  
    例（weekly\_release 内の先頭に追加）:
    ```yaml
    - uses: actions/download-artifact@v4
      with:
        name: catalog-dist-${{ needs.crawl_build.outputs.DATE }}
        path: dist
    ```
    もしくは、リリース作成を `crawl_build` と同じジョブ内でやる（簡単）案でもOK。
2.  **`needs.crawl_build.outputs.DATE` が未定義**  
    `crawl_build` にジョブ出力の明示が必要です。  
    例（jobs.crawl\_build 定義に追加）:
    ```yaml
    jobs:
      crawl_build:
        outputs:
          DATE: ${{ steps.sum.outputs.DATE }}
          COUNT: ${{ steps.sum.outputs.COUNT }}
    ```
    これがないと後続ジョブで参照できません。
3.  **週1の判定条件が曖昧**  
    `github.event.schedule` ベースの判定は扱いづらいので、**JSTの曜日を明示的に算出**してください（`TZ` は既に JST）。  
    例（weekly\_release 直前でフラグ化）:
    ```yaml
    - name: Check weekday (JST)
      id: wd
      run: echo "FRI=$([ $(date +%u) -eq 5 ] && echo true || echo false)" >> $GITHUB_OUTPUT
    # 以降のリリース作成ステップに:
    if: ${{ steps.wd.outputs.FRI == 'true' }}
    ```

🟠 Should-fix（強く推奨）
===================

*   **Artifacts 名の安定化**  
    `artifact_publish` のアップロード名と `download-artifact` の参照名を必ず一致させる（上記の DATE 出力を使う）。
*   **`scripts/nightly.sh` の堅牢化**
    *   先頭に `#!/usr/bin/env bash` と `set -euo pipefail`
    *   途中で `trap 'tail -n +1 logs/nightly.log || true' EXIT` などを入れて失敗時もログが見られるように
    *   出力の要約（件数など）を `JSON` 一行で `stdout` に出すと後段パースが安定
*   **ジョブタイムアウト**を設定（例：`timeout-minutes: 60`）  
    クローラが外部サイト都合で詰まる事があります。
*   **Artifacts アップロード**に `if-no-files-found: error` を付ける（配布物欠落の検知）
*   **Poetry install** は Nightly では `--only main` で十分（提案通り）。必要になったら昇格。

✍ 最小修正スニペット（そのまま追記/置換可）
=======================

**A) crawl\_build の outputs を定義**

```yaml
jobs:
  crawl_build:
    runs-on: ubuntu-latest
+   outputs:
+     DATE: ${{ steps.sum.outputs.DATE }}
+     COUNT: ${{ steps.sum.outputs.COUNT }}
    steps:
      # ... 既存のステップ ...
      - name: Save run summary
        id: sum
        run: |
          echo "DATE=$(date +%Y-%m-%d)" >> $GITHUB_OUTPUT
          COUNT=$(grep -Eo '"index_size": *[0-9]+' nightly.out | awk '{print $2}' | tail -n1)
          echo "COUNT=${COUNT:-0}" >> $GITHUB_OUTPUT
```

**B) artifact\_publish の名前合わせ（アップロード側）**

```yaml
- name: Upload dist artifacts
  uses: actions/upload-artifact@v4
  with:
-   name: catalog-dist-${{ needs.crawl_build.outputs.DATE || '' }}
+   name: catalog-dist-${{ needs.crawl_build.outputs.DATE }}
    path: |
      dist/catalog.duckdb
      dist/index.json
      dist/documents.ndjson
    retention-days: 14
```

**C) weekly\_release でダウンロード＋曜日判定**

```yaml
weekly_release:
  needs: crawl_build
  runs-on: ubuntu-latest
  if: ${{ needs.crawl_build.result == 'success' }}
  steps:
    - uses: actions/checkout@v4
+   - name: Download dist artifacts
+     uses: actions/download-artifact@v4
+     with:
+       name: catalog-dist-${{ needs.crawl_build.outputs.DATE }}
+       path: dist
+   - name: Check weekday (JST)
+     id: wd
+     run: echo "FRI=$([ $(date +%u) -eq 5 ] && echo true || echo false)" >> $GITHUB_OUTPUT
    - name: Set date
      id: d
      run: echo "DATE=$(date +%Y%m%d)" >> $GITHUB_OUTPUT
-   - name: Create Release
+   - name: Create Release
+     if: ${{ steps.wd.outputs.FRI == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: catalog-${{ steps.d.outputs.DATE }}
        name: Catalog ${{ steps.d.outputs.DATE }}
        generate_release_notes: true
        files: |
          dist/catalog.duckdb
          dist/index.json
          dist/documents.ndjson
```

**D) scripts/nightly.sh の雛形（要追加）**

```bash
#!/usr/bin/env bash
set -euo pipefail
mkdir -p dist logs
: > logs/nightly.log
echo "[nightly] start $(date -Iseconds)" | tee -a logs/nightly.log

poetry run itabashi-crawler --out dist/documents.ndjson 2>&1 | tee -a logs/nightly.log
poetry run catalog-load --in dist/documents.ndjson --duck dist/catalog.duckdb --index dist/index.json 2>&1 | tee -a logs/nightly.log

python - <<'PY' | tee -a logs/nightly.log
import json, os
idx = "dist/index.json"
size = os.path.getsize(idx) if os.path.exists(idx) else 0
print(json.dumps({"index_size": size}, ensure_ascii=False))
PY
```

* * *

この修正を反映すれば、#32 の**受け入れ基準を満たす Nightly パイプライン**になります。  
いまのプランに上記の修正を入れるようCodexへ伝えてください。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)