# スプリント2 Step3

Codex 指示 — Step 3: 最小API（FastAPI / SQLite+FTS5）
===============================================

ゴール
---

*   Step2で生成した `SQLite + FTS5` カタログを読む**最小API**を実装する。
*   エンドポイント：
    *   `GET /health`（疎通）
    *   `GET /search?q=&committee=&date_from=&date_to=&limit=&offset=`（minutes粒度の検索）
    *   `GET /document/{id}`（1件の minutes を議題・発言つきで返す）

前提
--

*   リポジトリ: `itabashi-minutes`
*   依存は Step0 済み（`fastapi`, `uvicorn[standard]`, `pydantic>=2`）。**新規依存は追加しない**。
*   DBスキーマは Step2 の `catalog/schema.sql` と `catalog/load.py` に準拠。

* * *

1) 追加・変更するファイル
--------------

```
api/
  __init__.py
  main.py                 # FastAPI本体 ／ create_app() ／ serve()
tests/
  test_api_e2e.py         # E2E（/health, /search, /document/{id}）
```

> **pyproject.toml は触らない。**（Step0 で `api-serve = "api.main:serve"` を登録済み。）

* * *

2) 実装仕様（`api/main.py`）
----------------------

### 2.1 アプリ構成

*   `create_app(db_path: str) -> FastAPI` を実装。テストではこのファクトリを直接使う。
*   `serve()` を実装し、CLI引数 `--db var/minutes.db --host 127.0.0.1 --port 8000` を受けて `uvicorn.run`。
*   SQLite 接続は **リクエスト毎に使い捨て**（依存関数 `get_conn()` を `yield` で実装）。
    *   `conn.row_factory = sqlite3.Row`
    *   `PRAGMA foreign_keys=ON;`
    *   `PRAGMA busy_timeout=5000;`

### 2.2 エンドポイント

*   `GET /health` → `{ "ok": true }`
*   `GET /search`
    *   クエリ:
        *   `q`（省略可。存在時はFTS5で `speeches_fts MATCH :q`）
        *   `committee`（省略可、完全一致）
        *   `date_from` / `date_to`（YYYY-MM-DD、範囲フィルタ）
        *   `limit`（default=20, 1..100）, `offset`（default=0, 0..10000）
    *   返却: minutes 粒度の配列とページングメタ
        ```json
        {
          "items": [
            {
              "id": 1,
              "meeting_date": "2025-08-21",
              "committee": "文教児童委員会",
              "title": "...",
              "hit_count": 3,
              "snippet": "…FTSで最初に当たった発言の先頭120字程度…"
            }
          ],
          "total": 1,
          "limit": 20,
          "offset": 0
        }
        ```
    *   SQL方針（擬似SQL：**実装時はパラメータバインド必須**）
        *   `q` あり → FTS5で minutes 単位に集約：
            ```sql
            WITH matched AS (
              SELECT sp.minutes_id AS mid,
                     COUNT(*) AS hits,
                     MIN(sp.id) AS first_sp_id
              FROM speeches_fts sfts
              JOIN speeches sp ON sp.id = sfts.rowid
              WHERE sfts MATCH :q
              GROUP BY sp.minutes_id
            )
            SELECT mn.id, mn.meeting_date, mn.committee, mn.title,
                   m.hits AS hit_count,
                   substr((SELECT speech_text FROM speeches WHERE id = m.first_sp_id), 1, 120) AS snippet
            FROM minutes mn
            JOIN matched m ON m.mid = mn.id
            WHERE ( :committee IS NULL OR mn.committee = :committee )
              AND ( :date_from IS NULL OR mn.meeting_date >= :date_from )
              AND ( :date_to   IS NULL OR mn.meeting_date <= :date_to )
            ORDER BY mn.meeting_date DESC, m.hits DESC
            LIMIT :limit OFFSET :offset;
            ```
        *   `q` なし → 最新順リスト（スニペットは当該 minutes の最初の発言120字）：
            ```sql
            SELECT mn.id, mn.meeting_date, mn.committee, mn.title,
                   0 AS hit_count,
                   substr((SELECT speech_text FROM speeches WHERE minutes_id = mn.id ORDER BY id ASC LIMIT 1), 1, 120) AS snippet
            FROM minutes mn
            WHERE ( :committee IS NULL OR mn.committee = :committee )
              AND ( :date_from IS NULL OR mn.meeting_date >= :date_from )
              AND ( :date_to   IS NULL OR mn.meeting_date <= :date_to )
            ORDER BY mn.meeting_date DESC, mn.id DESC
            LIMIT :limit OFFSET :offset;
            ```
        *   `total` は同じ条件で `COUNT(DISTINCT mn.id)` を別クエリで算出。
*   `GET /document/{id}`
    *   返却例：
        ```json
        {
          "id": 1,
          "meeting_date": "2025-08-21",
          "committee": "文教児童委員会",
          "title": "...",
          "page_url": "...",
          "pdf_url": "...",
          "agenda_items": [
            {
              "order_no": 1,
              "title": "【議題１ ...】",
              "speeches": [
                {
                  "speaker": "教育長",
                  "role": "教育長",
                  "paragraphs": ["...","..."]
                }
              ]
            }
          ]
        }
        ```
    *   実装方針：
        *   minutes 1件を取得
        *   `agenda_items` を `ORDER BY order_no` で全件取得
        *   当該 minutes の `speeches` を **一括取得** → `agenda_item_id` でグルーピング
            *   DBには `speech_text`（改行入り）しかないため、`speech_text.split("\n")` で `paragraphs` を構成

### 2.3 バリデーションとガード

*   `limit`/`offset` は上限・下限をサニタイズ。
*   `date_from` / `date_to` は `YYYY-MM-DD` 以外なら 422（FastAPIの `Query` バリデーションでも可）。
*   404: `/document/{id}` で minutes が見つからない場合。

* * *

3) テスト（`tests/test_api_e2e.py`）
-------------------------------

### 準備

*   `tmp_path` に `minutes.db` を作成：
    *   `sqlite3` で `catalog/schema.sql` を `executescript`
    *   `catalog.load.load_directory(db_path, Path("tests/fixtures"))` を呼んで、Step1のフィクスチャをロード

### ケース

1.  `/health` が 200 / `{"ok": true}`
2.  `/search`（`q=給食`）が 200 / items≥1 / 先頭要素に `id, meeting_date, committee, title, hit_count, snippet`  
    かつ `hit_count >= 1`
3.  `/search`（`committee=文教児童委員会` & `date_from=2025-08-01` & `date_to=2025-08-31`）で total≥1
4.  `/document/{id}` が 200 / `agenda_items.length >= 2` / どこかに `speaker="教育長"` を含む
5.  存在しないIDで 404

> テストは `create_app(str(db_path))` を使って `TestClient` で起動（uvicornは使わない）。

* * *

4) 受入基準（Step 3）
---------------

*   `poetry run pytest -q tests/test_api_e2e.py` がグリーン。
*   手元で `poetry run api-serve --db var/minutes.db --host 127.0.0.1 --port 8000` が起動し、例の `curl` が期待どおり。
*   大きな minutes でも `/document/{id}` がタイムアウトせず200（適切なクエリとPython側のグルーピングで対応）。

* * *

5) 実行コマンド（ローカル検証）
-----------------

```bash
# まずはテスト
poetry run pytest -q tests/test_api_e2e.py

# DBが未作成なら（Step2のDBを再現）
rm -f var/minutes.db && mkdir -p var
sqlite3 var/minutes.db < catalog/schema.sql
poetry run catalog-load --db var/minutes.db --src tests/fixtures/

# サーバ起動
poetry run api-serve --db var/minutes.db --host 127.0.0.1 --port 8000

# 動作確認
curl "http://127.0.0.1:8000/health"
curl "http://127.0.0.1:8000/search?q=給食&limit=5"
curl "http://127.0.0.1:8000/search?committee=文教児童委員会&date_from=2025-08-01&date_to=2025-08-31"
curl "http://127.0.0.1:8000/document/1"
```

* * *

6) 実装メモ（品質）
-----------

*   **SQLインジェクション回避**：必ず `?` / `:name` の **バインド**を使用（`MATCH` 句も同様）。
*   FTS無し検索でも `snippet` を返す（最初の発言120字）。
*   文字コードはUTF-8固定、JSONは `ensure_ascii=False`。
*   エラー時はFastAPI標準の 4xx/5xx を返す（独自HTMLは不要）。

* * *

以上。実装が上がったらテスト結果と `/search` のレスポンス例を送ってください。レビューして、OKならPR承認に進みます。