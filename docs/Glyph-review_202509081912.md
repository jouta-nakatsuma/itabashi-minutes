# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 19:11:02  
**Exported:** 9/8/2025 19:11:58  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 1m 7s

Joutaさんのコード変更について確認します。`mcp/server.py`で、`requests`が`mcp`の依存関係に含まれていないようですが、`requests`はUI部分で使用されているため、`pyproject`に含まれている可能性が高いです。ただし、確認が必要です。`_validate_params`での`is`比較は、意図した通りの動作を確認しましょう。

`is`の使用は問題ありません。行の折り返しで「committee」が壊れているが、ユーザーはそれに関しては無視して良いと言っています。`_map_http_error`は適切に辞書を返し、`ApiClient`のデータクラスはセッションを1回だけ呼び出す設計です。`ToolError`はカスタム例外として適切ですが、`jsonrpcserver`が例外をどのように処理するか、カスタムエラーメッセージを渡せるかが疑問です。

`ToolError`が返すのは「message」の文字列で、辞書は返されない可能性があります。これだと、`code`や`request_id`が失われるかもしれません。構造化されたエラーオブジェクトを返すために、`jsonrpcserver`の`Error`クラスを使う必要があります。現在のアプローチは、`code`をクライアントに伝えられない可能性があるため、確認が必要です。

純粋なJSON-RPCでは、MCPサーバーとして認識されません。ChatGPTのMCP統合は、MCP専用のメソッドを持つJSON-RPC 2.0を期待していますが、このパッチはその認識用のハンドシェイク（`initialize`, `tools/list`, `callTool`）を実装していません。このため、MCP統合は不十分で、目標が達成されない恐れがあります。

現在、MCPサーバーとして機能しないため、#31の基準を満たしていません。MCP SDKを実装する必要があり、fallbackだけでは受け入れ基準に達しません。また、エラーハンドリングや`ToolError`のマッピングについても改善の余地があります。さらに、`requests`の依存関係とCLIオプションの追加を検討すべきです。

完了

レビュー完了。結論：**この差分は“JSON-RPCフォールバックのみ”で、MCPサーバとしては未実装のため #31 の受入基準を満たしません（Blocking）**。その他は概ね良好です。

* * *

何ができているか（Good）
==============

*   `mcp/server.py`
    *   `.env`→`IM_API_BASE` 読み込み、`requests.Session`＋（任意）`Retry` 付き。
    *   `search_minutes`/`get_document` を **JSON-RPC（jsonrpcserver）** で公開。
    *   エラーを 404/400/422/5xx/timeout で分類（`code/message/request_id`）。
    *   轻いパラメータ検証（enum/min/max）とフォールバック（q空なら `order_by=date`）。
*   `mcp/manifest.json` でツール定義の雛形を追加。
*   `pyproject.toml` に **mcpオプショングループ** と `mcp-server` エントリ追加。
*   README にセットアップ・注意点追記。
*   tests に **依存未導入時 skip** の軽量テスト。

* * *

Blocking（必ず直す）
==============

1.  **MCP SDK 実装がない**  
    現在の `main()` はコメント通り「常に JSON-RPC フォールバック」を起動します。  
    これだと **ChatGPT/Claude の MCP クライアントからは認識されません**（MCP のハンドシェイクと `tools/list`/`tools/call` がないため）。  
    → 「mcp SDK があれば MCP サーバを起動、なければ JSON-RPC にフォールバック」という二段構えに戻してください。
    ### 最小差分案
    *   MCP SDK ルートを追加し、`main()` で import 成否に応じて切替。
    ```diff
    *** Update File: mcp/server.py
    @@
    -def main(argv: Optional[list[str]] = None) -> None:
    -    # For now, always run JSON-RPC fallback to avoid naming conflicts with the 
    -    # MCP SDK package.
    -    # A native MCP SDK implementation can be added later without breaking CLI.
    -    _stdio_jsonrpc_server()
    +import asyncio
    +
    +async def _mcp_sdk_server() -> None:
    +    """
    +    Native MCP (stdio) server if `mcp` package is available.
    +    Exposes tools: search_minutes, get_document
    +    """
    +    try:
    +        from mcp.server import Server
    +        from mcp.server.stdio import stdio_server
    +    except Exception:
    +        # SDK 未導入なら上位でフォールバック
    +        raise
    +
    +    server = Server("itabashi-minutes")
    +    api = ApiClient(get_api_base())
    +
    +    # JSON Schema は既存の SEARCH_SCHEMA / GETDOC_SCHEMA を流用
    +    @server.tool("search_minutes", SEARCH_SCHEMA, description="全文検索で会議録を探し、<em>強調</em>付きスニペットとメタ情報を返す。")
    +    async def _search_minutes(**kwargs):
    +        ok, msg = _validate_params(kwargs, SEARCH_SCHEMA)
    +        if not ok:
    +            raise ToolError("BadRequest", msg or "invalid params", request_id=str(uuid.uuid4())[:8])
    +        result = api.search(kwargs)
    +        # MCP の返却は JSON コンテンツ
    +        return {"content": [{"type": "json", "json": result}]}
    +
    +    @server.tool("get_document", GETDOC_SCHEMA, description="会議録1件の詳細（メタ・議題・発言・PDF URL）を返す。")
    +    async def _get_document(id: int):
    +        ok, msg = _validate_params({"id": id}, GETDOC_SCHEMA)
    +        if not ok:
    +            raise ToolError("BadRequest", msg or "invalid params", request_id=str(uuid.uuid4())[:8])
    +        result = api.get_document(int(id))
    +        return {"content": [{"type": "json", "json": result}]}
    +
    +    # stdio で待ち受け
    +    with stdio_server() as (read, write):
    +        print(f"[MCP] itabashi-minutes ready (base={api.base})", file=sys.stderr)
    +        await server.run(read, write)
    +
    +def main(argv: Optional[list[str]] = None) -> None:
    +    # まず MCP SDK を試し、無ければ JSON-RPC にフォールバック
    +    try:
    +        asyncio.run(_mcp_sdk_server())
    +    except Exception:
    +        _stdio_jsonrpc_server()
    ```
    > 注: 上記は SDK の典型パターンを最小限で示しています。SDK の API 名は 0系のマイナーで変わる可能性があるため、ビルドエラーが出たら該当 import とデコレータの引数名を微調整してください。

* * *

Should-fix（優先度: 中）
==================

2.  **JSON-RPC のエラー詳細がクライアントに渡らない可能性**  
    `ToolError` をそのまま投げると、jsonrpcserver 側ではコード/データが既定化される場合があります。  
    → `jsonrpcserver` の **Error** 型（v5系）を使って `data` に `ToolError.to_dict()` を詰めると意図が通ります。
    例：
    ```diff
    from jsonrpcserver import method, serve
    +from jsonrpcserver import Error as JrpcError
    ...
    @method
    def search_minutes(**kwargs: Any) -> Any:
        ok, msg = _validate_params(kwargs, SEARCH_SCHEMA)
        if not ok:
    ```
    *   ```
         raise ToolError("BadRequest", msg or "invalid params", request_id=str(uuid.uuid4())[:8])
    ```
*   ```
     return api.search(kwargs)
    ```
    *   ```
         te = ToolError("BadRequest", msg or "invalid params", request_id=str(uuid.uuid4())[:8])
    ```
*   ```
         raise JrpcError(code=-32000, message=te.message, data=te.to_dict())
    ```
*   ```
     try:
    ```
*   ```
         return api.search(kwargs)
    ```
*   ```
     except ToolError as te:
    ```
*   ```
         raise JrpcError(code=-32000, message=te.message, data=te.to_dict())
    ```
    ```
    `get_document` も同様に。
    ```

* * *

Nice-to-have（任意）
================

*   **CLI上書きオプション**：`--base http://...` で `.env` を上書きできると便利。
*   **共通設定の再利用**：UI と MCP の `get_api_base()` を `common/config.py` に集約。
*   **manifest.json**：`version` を `0.1.0` に揃え、tools の説明文を README と一致させる。

* * *

受入チェック観点（更新後）
=============

*   `poetry install --with mcp` → `poetry run mcp-server`
    *   **MCP SDK がある環境**：MCPサーバが立ち上がり、ChatGPT/Claude から `search_minutes`/`get_document` が **ツールとして認識**され、実行できる。
    *   **SDKが無い環境**：JSON-RPC サーバが起動し、手動で JSON-RPC 叩けば同機能が動作。
*   `order_by=relevance` + `q` 空 → date フォールバック。
*   エラー時：`code/message/request_id` がクライアントで確認できる。
*   CI：mcp 依存が無いジョブでも `tests/test_mcp_server.py` が skip で落ちない。

* * *

必要なら、上記 Blocking を取り込んだ**完全diff**にして返すコメント文も用意します。  
この修正を入れたうえで PR を切り、#31 をクローズしましょう。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)