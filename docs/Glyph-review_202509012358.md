# スプリント2

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 8/26/2025 19:06:41  
**Updated:** 9/1/2025 23:56:00  
**Exported:** 9/1/2025 23:58:26  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68ad872e-c17c-8323-8da9-03d735ff82cd](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68ad872e-c17c-8323-8da9-03d735ff82cd)  

## Response:
思考時間: 1m 20s

I’m thinking about how to handle the "q" string — whether to treat it as plain text or part of FTS syntax, with potential solutions like escaping or tokenizing. There's also the upper bound check to 10,000. For sorting, I’ll suggest including `id DESC`, and ensuring proper encoding and snippet handling, especially for multi-byte characters.

I’m reviewing date range inclusivity, confirming the query operators are correct, and considering plain vs FTS grammar. I propose sanitizing the translation between plain and FTS, ensuring correct escaping for quotes and handling the query structure. Also verifying proper concurrency with connections per request — I’ll ensure the correct connection handling approach for FastAPI.

I’m considering proposing Pydantic schemas for stable responses but also unsure about caching prepared statements. I noticed a mismatch in our FTS tokenization settings: while their plan mentions 'CJK 2/3-gram' and speaker/role inclusion, our current schema uses 'unicode61', which doesn’t include the 2/3-gram format or roles. Need to address this inconsistency carefully.

It seems like the speaker role isn’t included in the `speech_text` paragraphs, but the plan mentions it. Our FTS only searches `speech_text`, so a query like '教育長' won’t match unless it appears in the `speech_text`. We need to either extend the FTS to include speaker/role or adjust the plan to align with this restriction.

完了

穣太さん、拝見しました。結論から言うと――**このプランは概ね良好で、そのまま実装に入ってOK**です。ただし、完成度と将来の拡張性を高めるために、**小さな修正・明確化を6点**だけ加えることをおすすめします（いずれもStep 3の守備範囲内で収まります）。

承認方針（Approve with Nits）
=======================

以下を組み込む前提で**実装開始して問題なし**。

1) FTSの前提を明確化（speaker/roleは現状FTS対象外）
------------------------------------

*   現在の `speeches_fts` は **`speech_text` のみ**を索引対象にしています（Step 2仕様）。  
    プラン文中の「speaker/role含む」という記述は削ってください。
*   将来「話者名で検索」もしたい場合は、**別PRで** `speeches_fts(speech_text, speaker, role, …)` に拡張＋同期トリガ追加が妥当です（今回のStep 3ではやらない）。

2) FTSクエリの扱い（ユーザ入力 → MATCH式）
----------------------------

*   `MATCH :q` への**パラメータバインド徹底**はOK。その上で、
    *   ユーザが普通に「空白区切り」で入力した場合、**デフォルトは AND 連結**に正規化すると実用的です。  
        例：`"学校 給食"` → `学校 AND 給食`
    *   ダブルクオートや `OR` が含まれていれば**そのまま**通す（上級者のFTS文法を邪魔しない）。
    *   余分な全角空白の正規化、`"` のエスケープ（`""`）は実装しておくと事故りません。  
        → 小さなヘルパー `normalize_fts_query(q: str) -> str` を1関数用意しておくのがおすすめ。

3) 並び順の安定化（タイブレーク）
------------------

*   `/search` の `ORDER BY` は提案どおりでOKですが、**同日・同一hits**のケースで不安定にならないよう、最後に `, mn.id DESC` を足して安定化しておくとテストがブレません。
    *   `qあり`: `ORDER BY mn.meeting_date DESC, m.hits DESC, mn.id DESC`
    *   `qなし`: `ORDER BY mn.meeting_date DESC, mn.id DESC`

4) `/document/{id}` の完全性（順序と復元）
-------------------------------

*   `agenda_items` は **`ORDER BY order_no`** で取得。
*   `speeches` は **minutes単位で一括取得**し、**`ORDER BY agenda_item_id, id`** で安定化 → Python側で `agenda_item_id` ごとにグルーピング。
*   `paragraphs` は `speech_text.split("\n")`（空行は除外・末尾空白trim）。  
    この3点を明記しておくと、長文でもN+1を回避しつつ再現性が担保されます。

5) レスポンススキーマの固定（Pydanticモデル）
----------------------------

*   小さくて構いませんので、**レスポンス用のPydanticモデル**を定義して返却構造を固定化しておくと、今後のUIや別クライアント導入時に後方互換性チェックが効きます。
    *   `SearchItem`, `SearchResponse`
    *   `DocumentResponse`, `AgendaItemDTO`, `SpeechDTO`

6) バリデーションとエラー
--------------

*   `limit`/`offset` は FastAPI の `Query` で境界チェック（limit: 1..100, offset: 0..10000）→ 範囲外は **422**。
*   `date_from`/`date_to` は `datetime.date` 型で受ければ自動422。
*   `/document/{id}` の未存在は **404**（`HTTPException(status_code=404)`）。
*   DBパスが存在しない場合に 500 を出さないよう、**起動時（または最初のリクエスト時）に存在確認＋明快なメッセージ**があると親切です。

* * *

テスト観点（追補）
=========

プランのE2Eケースは十分です。以下の**軽い追加**があると堅牢性が上がります（テスト1〜2本でOK）。

*   `limit=0` / `limit=200` / `offset=-1` で **422 を確認**。
*   `q="学校 給食"` と `q="学校 AND 給食"` が**同等にヒット**すること（正規化の健全性）。
*   `q` なし検索で `snippet` が空文字ではなく、**最初の発言の先頭部**になっていること。

* * *

まとめ（実装GO判断）
===========

*   設計・エンドポイント・SQL方針・テスト構成、すべて妥当です。
*   上記6点の**調整を入れたうえで実装開始**してください。特に「FTSにspeaker/roleが含まれていない」点だけ表現修正をお願いします。
*   実装が上がったら、`/search` のレスポンス例（`q=給食` と `committee=文教児童委員会`）と、`/document/{id}` の1件を共有いただければ最終レビューに入ります。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)