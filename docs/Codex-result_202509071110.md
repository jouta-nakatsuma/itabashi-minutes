# Sprint 2 Step 5 実装報告（one_shot_apply） — 2025-09-07 11:10

- 概要: Glyph レビューで指摘された one_shot_apply の課題（CWD適用、EOL/BOM保持、パス安全性、push-back不具合、CRLFテスト）を解消し、ユニットテストを整備。CI グリーンでマージ済み。
- 対象PR: fix(one_shot_apply): robust parser, EOL/BOM preserve (Sprint2 Step5)

## 変更点サマリ
- 追加: `scripts/one_shot_apply.py`
  - Git形式の Unified diff を安全に適用（インデックスベースのパーサ／push-back安全）
  - EOL/BOM を保持、非空ファイルは末尾EOLを付与
  - パス安全性: `Path.is_relative_to`（fallback: `commonpath`）でリポジトリ外書き込みを防止
  - 既適用判定の正規化（`already_applied=True` 時は `skipped=0`）
  - 文脈マッチ: 単一の連続したコンテキストブロックのみをサポート（保守的適用）
  - 冪等性ガード: 既に `+` ブロックが反映済みの場合は重複追加を防止
- 追加: `scripts/rebuild_catalog.py`
  - `catalog/schema.sql` を適用し、JSON データをロード
  - `--src` 未指定または空のとき `data/normalized`→`tests/fixtures` をフォールバック
- 追加: テスト
  - `tests/test_one_shot_apply.py`: CWD固定、CRLF保持、add/delete/replace、コンテキスト不一致、冪等を検証
  - `tests/test_scripts_rebuild.py`: SQLite カタログ再構築スモーク
- 更新: README（本票適用後）
  - one_shot_apply の使い方、rebuild_catalog の使い方、Run 手順の整理

## レビュー対応（Glyph指摘事項）
- CWD適用: テストで `chdir(tmp_path)` を導入
- EOL/BOM保持: 書き込み時に BOM と EOL を復元
- パス安全性: `is_relative_to` / `commonpath` による安全確認
- diffパーサ: 反復子ベースから行配列＋インデックス管理へ変更（push-back安全）
- CRLFテスト: 末尾 `b"c\r\n"` をバイナリで検証
- 既適用/skipのセマンティクス: 「差分なし=常に already」ではなく、`applied==0 and skipped>0` の場合は未適用扱い

## 使い方（確認コマンド）
- ドライラン:
  - `git diff | poetry run python scripts/one_shot_apply.py --dry-run --strip 1`
- 実適用（バックアップ作成）:
  - `git diff | poetry run python scripts/one_shot_apply.py --strip 1 --backup`
- オプション:
  - `--strip`: 既定1、`a/`/`b/` の除去
  - `--fuzz`: 文脈ズレの許容
  - `--backup`: `.bak` 作成

## 期待ログ（例）
- `files=N applied=M skipped=K already=J`
- コンテキスト不一致時は `skipped` が正しくカウントされる
- 冪等適用時は `already` が増え、重複挿入が発生しない

## 成果物
- スクリプト: `scripts/one_shot_apply.py`, `scripts/rebuild_catalog.py`
- テスト: `tests/test_one_shot_apply.py`, `tests/test_scripts_rebuild.py`
- ドキュメント（本書）

## CI
- lint/format/mypy/pytest すべてグリーン
- スキーマ互換性チェック（変更なし）

## 備考
- diff適用のアルゴリズムは保守的（単一連続コンテキストのみ）です。複数離散コンテキストや高度な fuzz は将来の拡張対象とします。
