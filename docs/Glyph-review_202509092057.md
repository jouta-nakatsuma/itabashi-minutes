# ヘルスチェック対応方法

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/9/2025 19:13:44  
**Updated:** 9/9/2025 20:56:14  
**Exported:** 9/9/2025 20:57:11  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68bffdd8-467c-8329-8dc0-d63f099a5658](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68bffdd8-467c-8329-8dc0-d63f099a5658)  

## Response:
思考時間: 1 秒

ドキュメントを読み込んでいます

完了

レビュー結果：ほぼLGTM。CJK検出→ワイルドカード付与、LIKEフォールバック、スニペットのフォールバック、並び順の互換維持、README/pytest 追加まで一通り筋が良いです。特に `to_fts_query()` と CTE `f/l/u/mset` の構成は読みやすく、後方互換も保てています。スプリント3終了後確認

ただし、**小さな2点だけ手直し推奨**です（放置でも大崩れはしませんが、テスト安定と検索感の一貫性が上がります）。

MUST（テスト安定化）
------------

**tests/test\_api\_cjk\_like.py** は「トリガでFTSが埋まる」前提コメントですが、実環境ではトリガなし運用（rebuild 方式）に寄っています。なので、セットアップ後に **FTS再構築** を明示してください。

```diff
 def setup_db(tmp_path: Path) -> Path:
     ...
     with sqlite3.connect(db_path) as conn:
         conn.executescript(sql)
         ...
         conn.execute(
             "INSERT INTO speeches(..., speech_text) VALUES (1003, 3, 103, '事務局', '説明', 'その他 議会報告会')"
         )
-        conn.commit()
+        # 外部コンテンツFTSの再構築（トリガを仮定しない）
+        conn.execute("INSERT INTO speeches_fts(speeches_fts) VALUES('rebuild');")
+        conn.commit()
```

SHOULD（マッチ感の改善）
---------------

**LIKE パターンは `norm_q` ではなく “生の `q`” を使う**方がユーザー期待に沿います。`normalize_fts_query()` は FTS 向けの前処理（空白処理等）なので、LIKE 側は余計な正規化をかけないほうが自然です。

```diff
- like_pattern = f"%{norm_q}%"
+ like_pattern = f"%{q}%"
```

> もし `q` が空白のみなど極端なケースを気にするなら、`q.strip()` で空文字→LIKE無効化の分岐を入れてください（今の `:use_like` フラグ運用と整合）。

* * *

### そのほか軽微コメント（任意）

*   `highlight()/snippet()` は FTS 経由でしか効かないので、LIKE 専用ケースのスニペットは `substr(sp3.speech_text, 1, 120)` フォールバックでOK（現行の書き方で問題なし）。
*   `ORDER BY relevance` で `COALESCE(f.hits, 0)` を先頭に置いたのは適切。将来、LIKE のヒット数も加味したい場合は `hits + (CASE WHEN EXISTS(…LIKE…) THEN 1 ELSE 0 END)` のような「最低1点加算」も手です。
*   CJK判定の正規表現は十分。半角カナを拾いたいなら `\uff61-\uff9f` を足す選択肢もあります。

* * *

上記2点の反映で完成度は高いです。私は **適用OK** と判断します。

**approve apply**



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)