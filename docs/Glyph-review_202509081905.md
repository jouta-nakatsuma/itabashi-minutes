# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 19:04:43  
**Exported:** 9/8/2025 19:04:53  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
レビュー完了。結論：\*\*この実装プランで進めてOK（承認）\*\*です。API v0.2 を素直にプロキシする最小MCPとして妥当で、非破壊・小粒の方針も良いです。  
そのうえで、採用を推奨する“実装時の微修正/補強”を下にまとめます（いずれも小さく、品質と運用性が上がります）。

承認ポイント（満たしている要件）
================

*   stdio MCPサーバ（SDK優先／jsonrpcserverフォールバック）という構成は◎
*   公開ツール：`search_minutes` / `get_document`（API v0.2プロキシ）
*   `.env` の `IM_API_BASE`／既定 `http://127.0.0.1:8000`、タイムアウト `(3.0, 15.0)`
*   `order_by=relevance` かつ `q` 空時のフォールバック設計
*   Poetryの `group.mcp` と `mcp-server` エントリ追加、README追記の方針

改善提案（小粒・採用推奨）
=============

1.  入力バリデーションを**JSON Schemaで厳密化**
    *   MCP SDK登録時に、ツールパラメータへ schema を明示（enum/format/min/max）。
    *   フォールバック（jsonrpcserver）側も同じ定義でサーバ内チェック（失敗は 400 相当）。
2.  404/422 の**HTTP→MCPエラー変換**を明確に
    *   `404` → `{"code":"NotFound","message":...}`、`422/400` → `{"code":"BadRequest",...}`、`5xx/timeout` → `{"code":"UpstreamError",...}` のように分類。
    *   例外には `request_id` を付与し、stderrログには詳細を出す（表には簡潔メッセージのみ）。
3.  **requests.Session + 軽いリトライ**
    *   `Session()` に `HTTPAdapter(max_retries=Retry(total=2, backoff_factor=0.2))`（導入が重ければ自前sleepでも可）。夜間の一過性エラーに強くなります。
4.  **共通設定ユーティリティ**の切り出し（任意）
    *   `common/config.py` に `get_api_base()` を実装し、UI/MCPで共有（dotenv読込＋末尾スラッシュ除去）。
5.  **ツール説明文**を丁寧に
    *   `search_minutes`: 「板橋区議会の会議録を全文検索し、強調（<em>）付きスニペットとメタ情報を返す」
    *   `get_document`: 「会議録1件のメタ・議題・発言（段落配列）・PDF URLを返す」
6.  **軽量テスト**のskip条件
    *   `pytest.importorskip("mcp")` / `pytest.importorskip("jsonrpcserver")` を利用し、環境に依存せずCI通過。
7.  **実行ログの最小出力**
    *   起動時に `"[MCP] itabashi-minutes ready (base=...)"` をstderrに一行だけ。ノイジーにならないよう注意。
8.  **CLIオプション（任意）**
    *   `python -m mcp.server --base http://...` で `.env` を上書き可能にすると便利。
9.  **セキュリティ小ネタ**
    *   `order_by`/`order` の値は **whitelist** で分岐（既にAPI側がLiteralだが、MCP層でも二重に防御）。
10.  **manifest.json** の中身
    *   `name`, `description`, `tools`（名前・説明・parameters概要）を簡潔に。将来の拡張を想定し `version` 文字列も付与。

* * *

Codexへの返答ひな型（このまま送ってOK）
-----------------------

*   プランは承認です。そのまま **feat/31-mcp-v01** ブランチで実装に進んでください。
*   次の微修正を反映してください：
    1.  ツールパラメータの **JSON Schema 厳密化**（enum/format/min/max）。
    2.  **HTTPコードのマッピング**（404/400/422/5xx/timeout を分類）＋ `request_id`。
    3.  `requests.Session` に **軽いリトライ**（または簡易sleepリトライ）。
    4.  （任意）`common/config.py` の `get_api_base()` を作り UI/MCP で共有。
    5.  ツール説明文をユーザ視点で明確化。
    6.  テストは `importorskip` で **依存未導入でもskip**。
*   差分は unified diff で提示を。CI通過後にPR化→マージまでお願いします。

この方針で進めましょう。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)