# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/9/2025 0:45:43  
**Exported:** 9/9/2025 0:45:54  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 28s

リコール/精度計算の指標を、正規化された形式で重複排除し提案するかもしれません。誤検出を防ぐため、Unicodeカテゴリやコロンのバリエーションを考慮し、役割リストを活用して判断基準を確立します。また、エッジケースに対応するため、多様なパターンでテストケースを用意することも提案します。

ドキュメント本文を除外するため、２段階で処理することを提案します。例えば、"議題" で始まる場合、“に関する”を許可し、否定先読みは“議題|案件|...”が先行しない場合のみ適用。ページヘッダーやフッター線を除外するためのバウンディングや、CLIツール利用を考慮します。

*   'PyYAML'をpyprojectに追加；ランタイム用途でmainに

完了

レビュー完了。結論：\*\*この実装プランで進めてOK（承認）\*\*です。  
そのうえで、精度と運用をもう一段堅くするために、以下の“差し込みポイント”を提案します。いずれも小粒で、今回の方針と矛盾しません。

必ず入れてほしい（Should-fix）
====================

1.  **依存の明示**
    *   `PyYAML` を実行時依存（main）に追加（`yaml.safe_load` 用）。
    *   正規化で `unicodedata` を使う前提でOK。追加で `regex` ライブラリは不要（Python標準`re`で足りる）。
2.  **辞書/正規表現のキャッシュ**
    *   `resources/normalize.yml` は**モジュール読み込み時に一度だけロード**し、`lru_cache` or モジュール定数に保持。
    *   主要パターン（議題・話者）は\*\*`re.compile` 済みの定数\*\*に。Nightlyでも速度ぶれが減ります。
3.  **コロン/数字/丸印のゆらぎ許容**
    *   話者ヘッダの区切り記号は `[:：︓]`（ASCII/全角/互換）をサポート。
    *   議題番号：`第[〇一二三四五六七八九十百千0-9]+号`（漢数字＋算用）を網羅。
    *   行頭マーカー：`^[○◯●◎]?\s*` を共通プリフィックスに。
4.  **否定先読み（“について/に関する/の報告”）の適用条件を限定**
    *   「行頭が `議題|案件|議案第…号|請願|陳情|報告事項|所管事務調査` で始まる**見出し行**には適用しない」。
    *   それ以外の行でのみ否定先読みを効かせ、**本文中の説明文**を誤検知しないようにする。  
        → 本物の見出しでも「〜に関する報告」という標題は普通にあるため。
5.  **話者ロールのホワイトリスト化**
    *   `roles`（辞書のキー）を**許容役職**として利用し、ロールが一致しない場合は形式A/Bでも**見出しとみなさない**。
    *   例外は「氏名単独＋区切り（コロン）」の形式のみ許容。

できれば入れてほしい（Nice-to-have）
========================

*   **名前・役職の正規化前後での比較**  
    テストの Precision/Recall は「入力値→正規化後」同士で比較（`casefold`＋幅統一後）。
*   **スピーカー氏名の文字範囲**  
    追加で「長音・中黒・読点」を許容：`[一-龥々ヵヶ゙゜・・ー\u30A0-\u30FF\u3040-\u309F]`。
*   **フッター/ヘッダー除去の簡易前処理**  
    行頭に日付・ページ番号・固定ヘッダー（例：「― 1 ―」）が来たら除外。1～2行のルールで十分。
*   **メトリクスの集計方法**  
    ゴールデン複数本に対し**マイクロ平均**（TP/FP/FN の総和）で P/R を算出。ファイルごとの平均（マクロ平均）よりブレが少ないです。
*   **テストフィクスチャ**  
    2〜3本に加え、「`〜に関する報告` が正式見出し」ケースを1本追加しておくと否定先読みの副作用検知に効きます。
*   **Make タスク**  
    `make extract-test` に加え `make extract-sample FILE=...`（1ファイルだけの簡易実行）も便利。

サンプル差分スニペット（抜粋・そのまま足せます）
========================

**依存追加（pyproject.toml）**

```toml
[tool.poetry.dependencies]
PyYAML = "^6.0"
```

**辞書ロード/正規化のキャッシュ**

```python
# ingest/normalize.py
from functools import lru_cache
import unicodedata, yaml, re, pathlib

NFKC = lambda s: unicodedata.normalize("NFKC", s)

@lru_cache(maxsize=1)
def _load_dict():
    p = pathlib.Path(__file__).resolve().parents[1] / "resources" / "normalize.yml"
    with p.open("r", encoding="utf-8") as f:
        return yaml.safe_load(f) or {}

# 例: unify丸印・空白圧縮・記号統一
_space_re = re.compile(r"[ \t\u3000]+")
def normalize_text(s: str) -> str:
    s = NFKC(s)
    s = s.replace("◯", "○").replace("●", "○").replace("◎", "○")
    s = _space_re.sub(" ", s).strip()
    return s
```

**共通アンカー/コロン許容**

```python
# ingest/structure_extractor.py
COLON = r"[:：\uFE13]"  # ":" "：" "︓"
BULLET = r"[○◯●◎]?"
AGENDA_HEAD = rf"^(?:{BULLET}\s*)?(?:議題|案件|議案第[〇一二三四五六七八九十百千0-9]+号|請願第.*?号|陳情第.*?号|報告事項|所管事務調査)\s*{COLON}?\s*(?P<title>.+)$"

# 文中用法の誤検知抑制（見出し以外に限定）
NON_HEADING_EXCL = re.compile(rf"^(?!.*(について|に関する|の報告)\s*$).+")
```

**話者判定（役職ホワイトリスト＋区切り）**

```python
roles = set(_load_dict().get("roles", {}).keys())
ROLE = r"(?:委員長|委員|部長|課長|理事者|議長|副区長|教育長)"
NAME = r"[一-龥々ヵヶ゙゜・ー\u30A0-\u30FF\u3040-\u309F]{1,12}"

SPEAKER_A = re.compile(rf"^(?:{BULLET}\s*)?(?P<role>{ROLE})\s*(?P<name>{NAME})\s*{COLON}\s+(?P<body>.+)")
SPEAKER_B = re.compile(rf"^(?:{BULLET}\s*)?(?P<name>{NAME})\s*{COLON}\s+(?P<body>.+)")

# マッチ後に role が roles セットに入っているか最終チェック（正規化して比較）。
```

**テストのP/R（マイクロ平均）**

```python
# tests/test_structure_extractor.py
def pr(ground, pred):
    g = set(ground); p = set(pred)
    tp = len(g & p); fp = len(p - g); fn = len(g - p)
    prec = tp / (tp + fp) if (tp+fp) else 1.0
    rec  = tp / (tp + fn) if (tp+fn) else 1.0
    return prec, rec
```

* * *

以上。  
プランは承認で良いです。上の **Should-fix** を差し込むようCodexに伝えれば、#33の精度目標（P≥0.90 / R≥0.85）に現実的に届く構成になります。



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)