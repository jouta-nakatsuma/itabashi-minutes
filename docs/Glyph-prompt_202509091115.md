# タスク: Verification Cheatsheet（Sprint 3 完了版）

あなたは一旦ログアウトされ、前回までの記憶が失われています。まず **状況把握のために下記ファイル群を必ず読み込んでから** 着手してください。

## 1) 直近の状況（超要約）
- #29 **API v0.2**: `/search` に `limit/offset/order_by/order`、`page/has_next`、ハイライト `<em>`。  
- #30 **Streamlit UI v0.1**: 検索→一覧→詳細、relevanceはqあり時のみ、日付フィルタは任意ON。  
- #31 **MCPサーバ v0.1**: MCP SDK（stdio）優先、無ければ JSON-RPC フォールバック。構造化エラー返却。  
- CIは **二系統**（unit / mcp-smoke）＋ **週次MCP**、optional group 復帰済。  
- #32 **Nightly**: 毎晩クロール→カタログ→Artifacts、金曜は Release 作成、失敗時 Issue。  
- #33 **構造抽出**: 正規化辞書・正規表現の強化、Precision/Recall しきい値テスト。

## 2) 先に読むべきファイル/ディレクトリ
- `README.md`
- `.github/workflows/ci.yaml` / `.github/workflows/mcp-weekly.yml` / `.github/workflows/nightly.yml`
- `scripts/nightly.sh`
- `api/main.py`
- `app/ui_launcher.py` / `app/streamlit_app.py`
- `mcp/server.py`
- `ingest/patterns.py` / `ingest/normalize.py` / `resources/normalize.yml`
- `tests/test_structure_extractor.py`（存在すれば）
- `docs/スプリント3実装プラン(改訂版).md` / `docs/スプリント3_Issues対応順序.md`（存在すれば）
- `docs/Glyph-prompt_*.md` / `docs/Glyph-review_*.md`（存在すれば）

> **注意**: 以降の手順・コマンドは **macOS/Linux / bash**、**Poetry 1.8.3**、**Python 3.10** を想定。`IM_API_BASE` 既定は `http://127.0.0.1:8000`。

---

## 3) 成果物（このIssueのDone条件）
- 新規ドキュメント: `docs/Verification-Cheatsheet_Sprint3.md`
  - **目的**: 開発者/レビュアが **5〜10分** で Sprint 3 の完成物を横断チェックできること。
  - **構成（必須セクション）**:
    1. **準備**  
       - Poetry / 仮想環境、`.env`（`IM_API_BASE`）、サンプルDB（あれば `var/minutes.db`）  
       - 代表コマンド：`poetry install --only main,dev --with app,mcp`
    2. **API スモーク（2分）**  
       - 起動: `poetry run api-serve --db var/minutes.db --host 127.0.0.1 --port 8000`  
       - 確認:  
         - `curl 'http://127.0.0.1:8000/search?q=給食&limit=5&order_by=relevance' | jq`  
           → `items[].snippet` に `<em>` が含まれる  
         - `curl 'http://127.0.0.1:8000/search?limit=3&offset=3' | jq '.page,.has_next'`  
       - エラー系: `order_by=relevance` かつ `q` 空 → date フォールバック
    3. **UI スモーク（2分）**  
       - 起動: `poetry run ui-serve`  
       - 手順: キーワード検索→`<em>` 強調→Prev/Next→詳細→PDFリンク。  
       - オプション: 「日付で絞る」ON/OFF、「話者フィルタ（limit<=10）」動作確認。
    4. **MCP スモーク（2分）**  
       - 起動: `poetry run mcp-server` → `stderr` に `[MCP] itabashi-minutes ready`  
       - クライアントが無い環境向け：JSON-RPC フォールバック簡易呼び出し例（`printf` + `jq` もしくは最小 Python スニペット）  
         - `search_minutes` と `get_document` の呼び出し例と想定レスポンス形（`items/total/page/has_next`）
    5. **Nightly の確認（1分）**  
       - 手動実行: `gh workflow run Nightly --ref main` → `gh run watch`  
       - 成果物取得: `gh run download --name 'catalog-dist-YYYY-MM-DD'`  
       - 金曜のみ Release タグ `catalog-YYYYMMDD` を確認する手順
    6. **構造抽出の回帰（2分）**  
       - `poetry run pytest -q -k structure_extractor`  
       - しきい値: Precision ≥ 0.90 / Recall ≥ 0.85（失敗時は差分の見方を記載）
    7. **トラブルシュート**  
       - よくある失敗（ポート競合、`.env` 未設定、Streamlit未導入、MCP依存なし、外部サイト応答遅延）  
       - 対応: `IM_API_BASE` の上書き、`poetry install --with app,mcp`、`timeout-minutes`、Nightly ログの場所
    8. **付録**  
       - 期待 JSON スキーマ抜粋（`/search` のフィールド一覧）  
       - コマンド一覧（コピー&ペーストできるようコードブロックで）

- 任意だが歓迎: `scripts/verify_sprint3.sh`  
  - 上記の API/MCP 簡易スモークを **自動実行** し、成功/失敗を要約表示。  
  - 成果物に含めるかはあなたの判断（短いシェルでOK）。

- README 追記: `docs/Verification-Cheatsheet_Sprint3.md` へのリンクを「開発者向け」節に1行追加。

---

## 4) 実装方針（スコープ最小・非破壊）
- 既存コードは変更しない。**ドキュメント（と任意の簡易スクリプト）のみ**追加。  
- 例示コマンドは **すべて実行可能** で、**期待されるアウトプットの確認ポイント**（`jq` 抜粋や `grep`）を併記。  
- MCP セクションは SDK ルートと JSON-RPC ルートの **両方** を記載。

---

## 5) 受入基準（Done）
- `docs/Verification-Cheatsheet_Sprint3.md` が追加され、内容が上記セクションを満たす。  
- すべてのコマンドが（ローカル環境準備後に）そのまま実行でき、**目視で合否判定が可能**。  
- （任意）`scripts/verify_sprint3.sh` がある場合は `bash scripts/verify_sprint3.sh` で成功/失敗の要約が出る。  
- `README.md` に Cheatsheet へのリンクが追記されている。  
- PR は小粒コミットで構成され、CI green。

---

## 6) コミット/PR方針
- `docs(verify): add Verification-Cheatsheet_Sprint3`
- `chore(scripts): add verify_sprint3.sh (optional)`
- `docs(readme): link verification cheatsheet`

差分は **unified diff** で提示し、適用前にプレビューを出してください。
