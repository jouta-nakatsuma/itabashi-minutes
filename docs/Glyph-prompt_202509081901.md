# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 19:00:44  
**Exported:** 9/8/2025 19:01:11  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 1m 35s

ドキュメントを読み込んでいます

こちらでは、MCPサーバv0.1のCodex指示を作成する必要があります。以前のSprint 3計画に基づき、API検索やget\_documentにプロキシするMCPサーバを実装し、マニフェストやREADMEの指示も準備します。Node.jsかPythonでの実装が選択肢ですが、Pythonが使われているようです。

このプロジェクトでは、MCPサーバを構築するための完全な指示を作成する必要があります。具体的には`mcp/server.py`、`mcp/manifest.json`、スクリプト`mcp-server`を作成し、`search_minutes`や`get_document`関数も定義します。リクエストとレスポンスの形式やタイムアウト、バリデーション、ロギング、簡易的なレート制限に関する指針も含めます。

指示策定のため、必要なコードスケルトンを準備します。`mcp/server.py`，`pyproject.toml` のスクリプト `mcp-server = "mcp.server:main"`、マニフェストファイル `mcp/manifest.json`、READMEスニペットも必要です。テストについては最小限という方針ですが、今回は参照込みの詳細な引用は不要で進めます。

提供するツールには、`search_minutes`と`get_document`関数があります。引数をAPIに合わせて個別に定義し、最大10件の結果を返すようにします。また、MCPツール用のJSONスキーマを定義し、`manifest.json`も作成します。指示は簡潔に保ち、ChatGPTとClaude両方への設定例も含めます。

完了

了解。#31「MCPサーバ v0.1」の **Codex向け実装指示プロンプト** を用意しました。#29 の API v0.2（/search, /document/{id}）と #30 の `.env`（IM\_API\_BASE）を前提にしています。

* * *

Codex 実装指示プロンプト（#31 MCPサーバ v0.1）
--------------------------------

```markdown
# タスク: MCPサーバ v0.1（APIプロキシ）

## 目的
Itabashi Minutes を Model Context Protocol（MCP）から利用できる最小サーバを実装する。
`search_minutes` と `get_document` の2ツールを公開し、内部では既存の API v0.2（/search, /document/{id}）を呼び出す。

## スコープ / 成果物
- 新規: `mcp/server.py` … MCP stdio サーバ本体（Python）
- 新規: `mcp/manifest.json` … 簡易メタ（名称・説明・ツール一覧）
- 追記: `pyproject.toml` … `[tool.poetry.group.mcp]` 依存とスクリプト `mcp-server`
- 追記: `README.md` … セットアップとクライアント設定例
- 任意: `tests/test_mcp_server.py` … 最小の起動/登録テスト（mcp未導入環境ではskip）

## 実装要件
1) **ランタイム/依存**
- Python サーバ。まず `mcp` パッケージ（公式MCP Python SDK）を利用。
- フォールバック: `mcp` が未導入の環境では ImportError を捕捉し、`jsonrpcserver` を使った「簡易JSON-RPC（stdin/stdout）」で同等ツールを提供（CIが通るように）。
- Poetry にオプショングループを追加:
  ```toml
  [tool.poetry.group.mcp]
  optional = true
  [tool.poetry.group.mcp.dependencies]
  mcp = "^0"        # 利用可能な最新メジャー0系
  jsonrpcserver = "^5"
  requests = "*"    # 既存依存にあるなら省略可
  python-dotenv = "*"  # `.env` から IM_API_BASE を読む
```

*   スクリプト:
    ```toml
    [tool.poetry.scripts]
    mcp-server = "mcp.server:main"
    ```
    2.  **設定**
    *   APIベースURL: `IM_API_BASE`（既定 `http://127.0.0.1:8000`）。`.env` 読み込み可。
*   HTTPタイムアウト: `(connect=3.0, read=15.0)`。失敗時はエラーをツールエラーとして返却。
    3.  **公開ツール（JSON Schema）**
    *   `search_minutes`
    *   **params**:
        *   `q` (string, nullable)
        *   `committee` (string, nullable)
        *   `date_from` (string, format=date, nullable)
        *   `date_to` (string, format=date, nullable)
        *   `order_by` (string, enum: `["date","committee","relevance"]`, default `"date"`)
        *   `order` (string, enum: `["asc","desc"]`, default `"desc"`)
        *   `limit` (integer, minimum=1, maximum=100, default=10)
        *   `offset` (integer, minimum=0, default=0)
    *   **behavior**:
        *   `order_by="relevance"` かつ `q` 空ならクライアント混乱防止のため内部で `"date"` にフォールバック。
        *   `/search` を GET 呼び出し。返ってきた JSON をそのまま `application/json` として返却（`items/total/page/has_next` を含む）。
*   `get_document`
    *   **params**:
        *   `id` (integer, minimum=1)
    *   **behavior**: `/document/{id}` を GET 呼び出し。返ってきた JSON をそのまま返却。
        4.  **MCPサーバ実装指針（mcp SDK利用時）**
    *   サーバ名: `"itabashi-minutes"`
*   stdio で待ち受け。
*   ツール登録時に **JSON Schema** を明示。
*   実行時ログ（stderr）に起動行だけ出す: `"[MCP] itabashi-minutes ready (base=...)"`
    5.  **フォールバック（jsonrpcserver）**
    *   メソッド名は同じ（`search_minutes`, `get_document`）。引数・戻り値も同じ。
*   stdin/stdout の1プロセスJSON-RPCサーバで動作（MCPが使えない環境向けの簡易代替）。
    6.  **エラーハンドリング**
    *   4xx/5xx はツールエラーとして返却（`code` と `message` を含める）。
*   バリデーションエラー（例: 日付の逆転）は 400 同等で返す。
*   予期せぬ例外はスタックトレースを隠し、簡潔なメッセージ＋ `request_id` を返す。
    7.  **README 追記（抜粋）**
    *   インストール: `poetry install --with mcp`
*   起動: `poetry run mcp-server`
*   環境変数: `.env` に `IM_API_BASE=http://127.0.0.1:8000`
*   **クライアント設定例（Claude/ChatGPT）**:
    ```json
    {
      "mcpServers": {
        "itabashi-minutes": {
          "command": "python",
          "args": ["-m", "mcp.server"]
        }
      }
    }
    ```
    ※ あるいは `"command": "poetry", "args": ["run","mcp-server"]`。

受け入れ基準（Done）
------------

*   `poetry run mcp-server` で標準エラーに起動ログが出て、プロセスが stdio で待受。
*   MCP SDK があれば MCP ツールとして `search_minutes`/`get_document` が登録される。無い場合でも JSON-RPC 方法で同名メソッドが使える。
*   `search_minutes` が `/search` を叩き、`<em>` ハイライトを含む `items` を返す。
*   `get_document` が `/document/{id}` の内容（`title/meeting_date/committee/pdf_url/agenda_items` 等）をそのまま返す。
*   型/フォーマット不正で 400 相当のエラーが返る。
*   CI: lint/format/type が通り、mcpグループ未インストール時でもテストは skip で落ちない。

実装のヒント（構成案）
-----------

```
mcp/
  server.py        # main(), server起動, ツール登録, フォールバック
  manifest.json    # name, description, tools meta（開発者向け）
tests/
  test_mcp_server.py  # import とツール定義の存在確認（mcpなしはskip）
```

評価/手元検証コマンド
-----------

```bash
# 起動
poetry install --with mcp
poetry run mcp-server

# 疎通（簡易JSON-RPCフォールバックでの手動テスト例）
# （jqでメッセージを送って標準入力に与えるなど。MCPクライアントがあれば不要）
```

この要件どおりの差分（unified diff）を提示してください。小粒コミットを推奨:

*   feat(mcp): add stdio MCP server and tools
*   chore(poetry): add mcp group and launcher script
*   docs(mcp): README for setup and client config
*   test(mcp): add minimal registration test (skippable)

```
---
```



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)