# スプリント3実装計画

**User:** Anonymous (sunpin32@yahoo.co.jp)  
**Created:** 9/8/2025 16:17:26  
**Updated:** 9/8/2025 20:34:43  
**Exported:** 9/8/2025 20:35:01  
**Link:** [https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485](https://chatgpt.com/g/g-p-68a2428917408191ab595311b37e4516-itabashi-minutes/c/68be82fe-e1d0-832c-aceb-435dd9a31485)  

## Response:
思考時間: 37s

まず、READMEを更新してCIに関する情報を追加するか検討します。コンパクトにコミットリストを作成し、受け入れ基準を定義します。コードブロックでプロンプトを提示し、必要な変更は以下の通り：

*   pyproject.toml
*   .github/workflows/ci.yml（新規または修正）
*   .github/workflows/mcp-weekly.yml（オプショナル）
*   mcp/server.py
*   README.md（CIの言及は任意）

作業は簡潔でサポート的なスタイルに保ちつつ、背景処理は避けます。

mcp-smokeジョブでタイムアウトと「poetry run pytest -q -k mcp\_server || true」コマンドを追加して失敗を防ぐ。また、エラー時に修正のため「continue-on-error」を有効に。他に環境変数IM\_API\_BASEや構成の統一、プロセス終了方法も必要。それから、テストをスキップできるように調整。

「コードはリストされているファイル以外は操作しないでください」と記載。PRのためのコミットメッセージや指示も含む必要がある。Codexは「poetry lock」を実

完了

了解。以下をそのまま Codex に渡せば、**CI二系統化＋optional group復帰＋小さなコード整備**を一括でPR化できます。

* * *

Codex 実装指示プロンプト（CI二系統化 & MCP対応／#31フォローアップ）
------------------------------------------

```markdown
# タスク: CI二系統化（main/dev と with mcp）＋ optional group 復帰 ＋ 小さなコード整備

## 目的
- MCPを前提としない既存CIを維持しつつ、MCP有効時のスモークを別ジョブで追加。
- optional group `[tool.poetry.group.mcp]` を正式復帰。
- Lint安定化のための小さなコード整備を実施（mutable default回避・未使用import除去）。

## 変更方針（非破壊・小粒）
- 既存のCIジョブは `--only main,dev` のまま。
- 追加ジョブ `mcp-smoke` は `--with mcp` でインストールして最小スモーク。
  - 段階導入のため `continue-on-error: true`（必要なら後で外せる）。
- 週次スケジュールで `with mcp` のマトリクス（3.9/3.10/3.11）を別Workflowで実行（任意だが実装してOK）。
- `mcp/server.py` の `ApiClient.session` は `default_factory` 化、未使用import削除。

## 変更対象
- `.github/workflows/ci.yml`（新規または追記）
- `.github/workflows/mcp-weekly.yml`（新規）
- `pyproject.toml`（mcpグループの正式復帰。既にある場合は変更なし）
- `mcp/server.py`（default_factory と未使用import）
- （任意）`README.md` に CIの注意事項を1行追記

## 実装詳細

### 1) pyproject.toml（optional group 復帰確認/追記）
- `[tool.poetry.group.mcp]` を定義（optional=true）。
- 依存（例）:
  ```toml
  [tool.poetry.group.mcp]
  optional = true
  [tool.poetry.group.mcp.dependencies]
  mcp = "^0"
  jsonrpcserver = "^5"
  python-dotenv = "*"
```

*   既に存在する場合は変更不要。存在しなければ追加。

### 2) `.github/workflows/ci.yml`

*   PR/Push トリガーで2ジョブ:
    *   `unit`: main+dev のみで Lint/Type/Test。
    *   `mcp-smoke`: with mcp でロック再生成→インストール→スモーク。
*   最小例:
    ```yaml
    name: CI
    on:
      pull_request:
      push:
        branches: [ main ]
    jobs:
      unit:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with: { python-version: '3.10' }
          - name: Install poetry
            run: pipx install poetry==1.8.3
          - name: Install (main+dev)
            run: poetry install --only main,dev
          - name: Lint & Type & Test
            run: |
              poetry run ruff check .
              poetry run black --check .
              poetry run mypy .
              poetry run pytest -q
      mcp-smoke:
        runs-on: ubuntu-latest
        continue-on-error: true   # 段階導入。安定後に外して良い
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with: { python-version: '3.10' }
          - name: Install poetry
            run: pipx install poetry==1.8.3
          - name: Refresh lock & Install with mcp
            run: |
              poetry lock
              poetry install --only main,dev --with mcp
          - name: MCP import tests (optional)
            run: poetry run pytest -q -k mcp_server || true
          - name: MCP smoke (stderrで起動ログを確認)
            run: |
              set -e
              (poetry run mcp-server 2>stderr.log & echo $! > pid.txt)
              sleep 2
              grep -q "\[MCP\] itabashi-minutes ready" stderr.log
              kill $(cat pid.txt) || true
    ```

### 3) `.github/workflows/mcp-weekly.yml`（任意・週次マトリクス）

*   コスト最小化のため、週1回のみ `--with mcp` を複数Pythonで回す:
    ```yaml
    name: MCP Weekly
    on:
      schedule:
        - cron: '0 18 * * 5' # Fri 18:00 UTC
    jobs:
      matrix:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            py: [ '3.9', '3.10', '3.11' ]
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with: { python-version: ${{ matrix.py }} }
          - run: pipx install poetry==1.8.3
          - run: poetry lock
          - run: poetry install --only main,dev --with mcp
          - run: poetry run pytest -q -k mcp_server || true
          - run: timeout 5s poetry run mcp-server || true
    ```

### 4) `mcp/server.py` の小さな整備

*   mutable default 回避と未使用import削除のみ（機能は変更しない）。
    ```diff
    --- a/mcp/server.py
    +++ b/mcp/server.py
    -import json
    -import time
    -from dataclasses import dataclass
    +from dataclasses import dataclass, field
     ...
     @dataclass
     class ApiClient:
         base: str
         timeout: Tuple[float, float] = (3.0, 15.0)
    -    session: requests.Session = build_session()
    +    session: requests.Session = field(default_factory=build_session)
    ```

### 5) README（任意）

*   「CIは main/dev と with mcp の二系統。with mcp はスモーク（段階導入中）」を1行追記。

受け入れ基準（Done）
------------

*   CIの `unit` ジョブが従来どおり成功する。
*   `mcp-smoke` ジョブが `continue-on-error: true` のもとで起動ログ確認が通る。
*   週次 `MCP Weekly` がスケジュール登録される（実行は次回スケジュール時）。
*   `mcp/server.py` の整備で Lint/Type が安定（CI green）。

出力
--

*   上記を反映した **unified diff** を提示し、小粒コミットでPR化。
    *   `chore(ci): split CI (unit / mcp-smoke)`
    *   `chore(ci): add weekly MCP matrix workflow`
    *   `chore(poetry): restore optional mcp group`
    *   `chore(mcp): default_factory for requests.Session & cleanup imports`
    *   `docs(ci): note dual CI tracks`

```

---

必要なら「週次Workflowは別PRに分ける」指示も追記できますが、今は一括でOKです。
```



---
Powered by [ChatGPT Exporter](https://www.chatgptexporter.com)